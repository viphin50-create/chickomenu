<!DOCTYPE html><html lang="ru"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чико New - Меню</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    /* Google Font: Inter */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      /* Очень светлый серый фон */
      background: #F8F8F8;
      min-height: 100vh;
      overflow-x: hidden;
      color: #333;
    }

    /* Стили скроллбара */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    /* Анимация плавного появления */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Кнопки фильтров и поиска с эффектом стекла, адаптированные под белый фон */
    .glass-btn {
      background: rgba(240, 240, 240, 0.7);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(200, 200, 200, 0.8);
      color: #333;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .glass-btn:hover {
      background: rgba(230, 230, 230, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
    }

    .glass-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) inset;
    }

    .glass-btn.active {
      background: #FF5E62;
      /* Активный фон - яркий цвет бренда */
      color: white;
      font-weight: 800;
      border: 1px solid #FF5E62;
    }

    /* Картинки */
    .img-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Стили для модального окна */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      /* Затемненный фон */
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s forwards;
    }

    .modal-content {
      background: #FFFFFF;
      margin: 10% auto;
      /* Отступ сверху */
      padding: 2rem;
      border-radius: 1.5rem;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      animation: slideIn 0.3s forwards;
    }

    .close-btn {
      color: #aaa;
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 28px;
      font-weight: bold;
      transition: color 0.3s;
    }

    .close-btn:hover,
    .close-btn:focus {
      color: #FF5E62;
      text-decoration: none;
      cursor: pointer;
    }

    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    /* --- Стили для навигации --- */
    .nav-link {
        color: #6b7280; /* text-gray-500 */
        transition: color 0.3s, border-bottom 0.3s;
        padding-bottom: 4px;
        font-size: 1.125rem; /* text-lg */
    }
    .nav-link:hover {
        color: #FF5E62;
    }
    .active-nav-link {
        color: #FF5E62;
        border-bottom: 4px solid #FF5E62;
        font-weight: 700;
    }
    .page-content {
        /* Чтобы избежать CLS, установим минимальную высоту */
        min-height: 50vh;
    }
    /* Утилита для скрытия элемента */
    .hidden {
        display: none !important;
    }

    /* Стиль для кнопок материалов */
    .training-button {
      background-color: #ffffff;
      border: 1px solid #FF5E62;
      color: #FF5E62;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(255, 94, 98, 0.2);
    }
    .training-button:hover {
      background-color: #FF5E62;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 94, 98, 0.4);
    }
  </style></head><body class="p-4 sm:p-8 flex flex-col items-center justify-center">
  <div class="max-w-5xl mx-auto w-full">

    <!-- Заголовок -->
    <div class="flex justify-center mt-4 mb-4">
      <h1 class="text-5xl sm:text-6xl font-extrabold text-gray-800 drop-shadow-lg tracking-wide">
        ЧИКО <span class="text-red-500 text-3xl align-top">New</span>
      </h1>
    </div>

    <!-- Навигационные ссылки -->
    <div id="navigation-links" class="flex justify-center gap-6 mb-8 mt-4 font-bold">
        <button class="nav-link active-nav-link" onclick="showPage('menu')">Меню</button>
        <button class="nav-link" onclick="showPage('training')">Обучающий материал</button>
    </div>
    
    <!-- КОНТЕНТ СТРАНИЦЫ МЕНЮ -->
    <div id="menu-content" class="page-content">
        <!-- Поиск -->
        <div id="search-container" class="w-full mb-6 max-w-2xl mx-auto">
          <div class="relative rounded-full shadow-lg">
            <input type="text" id="search-input" placeholder="Поиск по названию или аллергенам..."
              class="glass-btn w-full px-6 py-3 rounded-full pl-12 transition-all duration-300 text-gray-800 placeholder-gray-500">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 text-xl"></i>
          </div>
        </div>

        <!-- Кнопки-фильтры по категориям -->
        <div id="filter-buttons" class="flex flex-wrap justify-center gap-2 mb-8"></div>

        <!-- Основная область контента (Список) -->
        <div class="flex flex-col items-center w-full">

          <!-- Индикатор загрузки -->
          <div id="loading-spinner" class="text-center py-12">
            <svg class="animate-spin h-12 w-12 text-[#FF5E62] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.965l3-2.674zm13.715-6.195A7.962 7.962 0 0120 12h4c0-3.042-1.135-5.824-3-7.965l-3 2.674zM12 20a8 8 0 008-8h4c0 6.627-5.373 12-12 12v-4z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-medium text-lg">Загрузка меню...</p>
          </div>

          <!-- Область отображения списка -->
          <div id="card-container"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full max-w-6xl px-4">
          </div>

        </div>
    </div>
    
    <!-- КОНТЕНТ СТРАНИЦЫ ОБУЧАЮЩИЙ МАТЕРИАЛ -->
    <div id="training-content" class="page-content hidden">
        <div class="max-w-4xl mx-auto p-6 bg-white/70 backdrop-blur-md rounded-2xl shadow-xl border border-white/90">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 border-red-200 text-center">
                База Обучающих Материалов
            </h2>
            
            <!-- Контейнер для кнопок, загружаемых из Google Sheets -->
            <div id="training-links-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Сюда будут вставлены кнопки -->
            </div>

            <!-- Индикатор загрузки для обучающего материала -->
            <div id="training-loading-spinner" class="text-center py-12 hidden">
                <svg class="animate-spin h-12 w-12 text-[#FF5E62] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.965l3-2.674zm13.715-6.195A7.962 7.962 0 0120 12h4c0-3.042-1.135-5.824-3-7.965l-3 2.674zM12 20a8 8 0 008-8h4c0 6.627-5.373 12-12 12v-4z"></path>
                </svg>
                <p class="mt-4 text-gray-600 font-medium text-lg">Загрузка материалов...</p>
            </div>
            
        </div>
    </div>


  </div>

  <!-- Модальное окно для детального просмотра -->
  <div id="product-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="modal-body" class="space-y-4">
        <!-- Содержимое будет вставлено сюда через JS -->
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Ссылка на таблицу Google Sheets для МЕНЮ в формате CSV
      // Убедитесь, что эта ссылка опубликована и содержит gid=993893041
      const SHEET_URL_MENU = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT0ukbh5K5GdykFFCDj-H0xUODUAneKWmbeJFfe4tLTCMEWKJgCkefhrCOtsKDB_QRRYySAvI1xOTh3/pub?gid=993893041&single=true&output=csv';
      
      // Ссылка на таблицу Google Sheets для ОБУЧАЮЩЕГО МАТЕРИАЛА в формате CSV
      // Эта ссылка была предоставлена пользователем и содержит gid=1664366590
      const SHEET_URL_TRAINING = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT0ukbh5K5GdykFFCDj-H0xUODUAneKWmbeJFfe4tLTCMEWKJgCkefhrCOtsKDB_QRRYySAvI1xOTh3/pub?gid=1664366590&single=true&output=csv'; 
      
      const cardContainer = document.getElementById('card-container');
      const menuSpinner = document.getElementById('loading-spinner');
      const trainingLinksContainer = document.getElementById('training-links-container');
      const trainingSpinner = document.getElementById('training-loading-spinner');
      const filterButtonsContainer = document.getElementById('filter-buttons');
      const searchInput = document.getElementById('search-input');
      const productModal = document.getElementById('product-modal');
      const modalBody = document.getElementById('modal-body');
      
      const menuContent = document.getElementById('menu-content');
      const trainingContent = document.getElementById('training-content');

      let allProducts = [];
      let displayedProducts = [];
      let allTrainingMaterials = []; // Новый массив для обучающих материалов

      // --- UTILITIES ---
      
      /**
       * Выполняет fetch-запрос с логикой экспоненциальной задержки для повышения отказоустойчивости.
       * @param {string} url - URL для запроса.
       * @param {number} maxRetries - Максимальное количество попыток.
       * @param {number} delay - Начальная задержка в миллисекундах.
       * @returns {Promise<Response>} Ответ fetch.
       */
      async function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
          for (let i = 0; i < maxRetries; i++) {
              try {
                  const res = await fetch(url);
                  if (!res.ok) {
                      // Бросаем ошибку, если статус ответа не 2xx
                      throw new Error(`HTTP error! Status: ${res.status}`);
                  }
                  return res;
              } catch (error) {
                  console.error(`Attempt ${i + 1} failed for ${url}:`, error);
                  if (i < maxRetries - 1) {
                      // Ждем с использованием экспоненциальной задержки перед повторной попыткой
                      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                  } else {
                      // Повторно выбрасываем ошибку после последней попытки
                      throw error;
                  }
              }
          }
      }

      /**
       * Парсит CSV текст из Google Sheets.
       * @param {string} text - Сырой CSV текст.
       * @param {string} mode - 'menu' или 'training' для настройки нормализации ключей.
       * @returns {Array<Object>} Массив объектов с данными.
       */
      function parseCSV(text, mode) {
        const results = [];
        const lines = text.split(/\r?\n/).filter(line => line.trim());

        if (lines.length === 0) return [];

        const splitCSVLine = (line) => {
          const rowData = [];
          let currentCell = '';
          let inQuote = false;

          for (let j = 0; j < line.length; j++) {
            const char = line[j];

            if (char === '"') {
              if (j + 1 < line.length && line[j + 1] === '"') {
                currentCell += '"';
                j++;
              } else {
                inQuote = !inQuote;
              }
            } else if (char === ',' && !inQuote) {
              rowData.push(currentCell);
              currentCell = '';
            } else {
              currentCell += char;
            }
          }
          rowData.push(currentCell);

          return rowData.map(cell => {
            let cleanCell = cell;
            if (cleanCell.startsWith('"') && cleanCell.endsWith('"')) {
              cleanCell = cleanCell.substring(1, cleanCell.length - 1);
            }
            return cleanCell.replace(/""/g, '"').trim();
          });
        };

        const rawHeader = splitCSVLine(lines[0]);
        const header = rawHeader.map(h => h.toLowerCase().trim());

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          const lineNumber = i + 1;
          const rowData = splitCSVLine(line);

          if (rowData.length === header.length) {
            const item = {};
            header.forEach((key, index) => {
              item[key] = rowData[index] || '';
            });

            // --- НОРМАЛИЗАЦИЯ КЛЮЧЕЙ ДЛЯ МЕНЮ ---
            if (mode === 'menu') {
              const pName = item['name'] || item['название'] || item['блюдо'] || '';
              if (pName) {
                item.display_name = pName;
                item.display_image = item['image'] || item['ссылка на фото'] || item['фото'] || 'https://placehold.co/400x600/FFFFFF/FF5E62?text=Нет+Фото';
                item.display_desc = item['описание'] || item['подача'] || 'Описание отсутствует';
                item.display_allergen = item['allergen'] || item['аллергены'] || 'Нет данных';
                item.display_category = item['category'] || item['категория'] || 'Общее';
                results.push(item);
              } else {
                console.warn(`Line ${lineNumber} skipped (Menu): Product name field is empty.`);
              }
            // --- НОРМАЛИЗАЦИЯ КЛЮЧЕЙ ДЛ'я ОБУЧЕНИЯ ---
            } else if (mode === 'training') {
                // Ищем поля "Название" и "ссылка"
                const tName = item['название'] || item['title'] || '';
                const tLink = item['ссылка'] || item['link'] || '';
                
                if (tName && tLink) {
                    item.display_name = tName;
                    item.display_link = tLink;
                    results.push(item);
                } else {
                    console.warn(`Line ${lineNumber} skipped (Training): Missing Title or Link.`);
                }
            }
          } else {
            console.warn(`Line ${lineNumber} skipped: Column count mismatch.`);
          }
        }
        return results;
      }

      // --- MENU VIEW FUNCTIONS (Unchanged) ---

      /**
       * Отрисовывает режим списка блюд (List View).
       */
      function renderListView() {
        if (displayedProducts.length === 0) {
          cardContainer.innerHTML = '<p class="col-span-full text-gray-800 text-center text-xl font-bold">Блюда не найдены</p>';
          return;
        }

        const html = displayedProducts.map((product, index) => `
            <!-- Клик по карточке теперь открывает модальное окно -->
            <div class="bg-white/80 backdrop-blur-md border border-white/90 rounded-2xl overflow-hidden shadow-xl flex flex-col animate-fade-in hover:scale-[1.02] transition-all duration-300 cursor-pointer" 
                 onclick="openModal(${index})">
                <div class="h-48 overflow-hidden relative">
                    <img src="${product.display_image}" onerror="this.src='https://placehold.co/400x600/FFFFFF/FF5E62?text=Фото+нет'" class="w-full h-full object-cover" loading="lazy">
                    <span class="absolute top-2 right-2 bg-black/50 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm font-semibold">
                        ${product.display_category}
                    </span>
                </div>
                <div class="p-4 text-gray-800 flex-grow flex flex-col">
                    <h3 class="text-xl font-bold mb-2">${product.display_name}</h3>
                    <!-- Показываем короткое описание -->
                    <p class="text-sm text-gray-700 mb-3 flex-grow line-clamp-3">${product.display_desc}</p>
                    <div class="mt-auto pt-3 border-t border-gray-200">
                        <p class="text-xs font-bold text-red-500"><i class="fas fa-exclamation-triangle mr-1"></i> Аллергены: ${product.display_allergen}</p>
                    </div>
                </div>
            </div>
        `).join('');

        cardContainer.innerHTML = html;
      }

      // --- TRAINING VIEW FUNCTIONS (New) ---

      /**
       * Отрисовывает кнопки обучающих материалов.
       */
      function renderTrainingButtons() {
        trainingLinksContainer.innerHTML = ''; // Очистка контейнера

        if (allTrainingMaterials.length === 0) {
          trainingLinksContainer.innerHTML = '<p class="col-span-full text-gray-800 text-center text-lg mt-8">Нет доступных обучающих материалов. Проверьте ссылку на Google Sheet и заголовки столбцов ("Название" и "ссылка").</p>';
          return;
        }

        const html = allTrainingMaterials.map(material => `
            <a href="${material.display_link}" target="_blank" rel="noopener noreferrer" 
               class="training-button flex items-center justify-between p-4 rounded-xl shadow-lg transition-all duration-300 animate-fade-in">
                <span class="text-lg truncate">${material.display_name}</span>
                <i class="fas fa-arrow-right ml-4"></i>
            </a>
        `).join('');

        trainingLinksContainer.innerHTML = html;
      }


      // --- MODAL FUNCTIONS (Unchanged) ---

      /**
       * Открывает модальное окно с деталями выбранного блюда.
       * @param {number} index - Индекс выбранного продукта в массиве displayedProducts.
       */
      window.openModal = function (index) {
        const product = displayedProducts[index];
        if (!product) return;

        modalBody.innerHTML = `
          <img src="${product.display_image}" onerror="this.src='https://placehold.co/400x600/FFFFFF/FF5E62?text=Нет+Фото'" 
               class="w-full h-auto rounded-xl mb-4 shadow-lg object-cover max-h-64">
          
          <div class="text-center mb-4">
              <span class="text-sm font-bold text-amber-600 uppercase tracking-wider bg-amber-100 px-3 py-1 rounded-full">${product.display_category}</span>
              <h2 class="text-3xl font-extrabold text-gray-800 mt-2">${product.display_name}</h2>
          </div>

          <div class="space-y-4 text-gray-700">
              <div class="p-3 rounded-xl border border-gray-100 bg-gray-50/50">
                  <div class="flex items-center mb-1 font-bold text-gray-800">
                      <i class="fas fa-align-left text-amber-500 mr-2"></i>
                      <span>Описание/Состав:</span>
                  </div>
                  <p class="text-base leading-relaxed">${product.display_desc}</p>
              </div>

              <div class="p-3 rounded-xl border border-red-200 bg-red-50">
                  <div class="flex items-center mb-1 font-bold text-red-700">
                      <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                      <span>Аллергены:</span>
                  </div>
                  <p class="text-base font-semibold text-red-600">${product.display_allergen}</p>
              </div>
          </div>
        `;
        productModal.style.display = 'block';
      }

      /**
       * Закрывает модальное окно.
       */
      window.closeModal = function () {
        productModal.style.display = 'none';
      }

      // Закрытие модального окна при клике вне его
      window.onclick = function (event) {
        if (event.target == productModal) {
          closeModal();
        }
      }

      // --- FILTERING (Unchanged) ---

      /**
       * Фильтрует отображаемые карточки по категории.
       * @param {string} category - Выбранная категория.
       */
      function filterCards(category) {
        const searchValue = searchInput.value.toLowerCase();

        // Фильтруем по категории
        let filteredByCategory = category === 'Все' ? allProducts :
          allProducts.filter(p => p.display_category === category);

        // Фильтруем по поисковой строке (название или аллергены)
        displayedProducts = filteredByCategory.filter(p =>
          p.display_name.toLowerCase().includes(searchValue) ||
          p.display_allergen.toLowerCase().includes(searchValue)
        );

        renderListView();
      }

      /**
       * Создает кнопки для фильтрации по уникальным категориям.
       * @param {Array<Object>} products - Список всех продуктов.
       */
      function createFilterButtons(products) {
        const categories = ['Все', ...new Set(products.map(p => p.display_category).filter(c => c))];
        filterButtonsContainer.innerHTML = '';

        categories.forEach(cat => {
          const btn = document.createElement('button');
          btn.textContent = cat;
          btn.className = 'glass-btn px-4 py-1 rounded-full text-sm font-medium whitespace-nowrap';
          if (cat === 'Все') btn.classList.add('active');

          btn.addEventListener('click', (e) => {
            document.querySelectorAll('#filter-buttons button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            filterCards(cat);
          });
          filterButtonsContainer.appendChild(btn);
        });
      }
      
      /**
       * Переключает отображение страниц (Меню или Обучающий материал).
       * @param {string} pageId - 'menu' или 'training'.
       */
      window.showPage = function (pageId) {
        const navButtons = document.querySelectorAll('.nav-link');

        // Сброс активного класса у всех кнопок
        navButtons.forEach(btn => btn.classList.remove('active-nav-link'));
        document.querySelector(`button[onclick="showPage('${pageId}')"]`).classList.add('active-nav-link');


        if (pageId === 'menu') {
          menuContent.classList.remove('hidden');
          trainingContent.classList.add('hidden');
          // Сброс поиска при переключении на Меню
          searchInput.value = '';
          const activeFilter = document.querySelector('#filter-buttons button.active')?.textContent || 'Все';
          filterCards(activeFilter);
        } else if (pageId === 'training') {
          menuContent.classList.add('hidden');
          trainingContent.classList.remove('hidden');
          // Загрузка данных для обучения при переходе на страницу
          loadTrainingData();
        }
      }


      // --- FETCH DATA FOR MENU ---
      async function loadMenuData() {
        menuSpinner.style.display = 'block';
        cardContainer.innerHTML = '';
        try {
          // Используем fetchWithRetry
          const res = await fetchWithRetry(SHEET_URL_MENU);
          const text = await res.text();

          allProducts = parseCSV(text, 'menu');

          if (allProducts.length === 0) {
            throw new Error('No valid product data found in the sheet.');
          }

          displayedProducts = [...allProducts];

          createFilterButtons(allProducts);
          renderListView(); 

        } catch (e) {
          console.error('Menu Data Load Error:', e);
          cardContainer.innerHTML = `<div class="col-span-full text-gray-800 text-center bg-red-100 p-6 rounded-xl shadow-lg border border-red-300 max-w-lg mx-auto mt-8">
                                      <p class="font-bold mb-2">Ошибка загрузки меню!</p>
                                      <p class="text-sm">Не удалось загрузить данные. Пожалуйста, проверьте: 1) Ваше интернет-соединение, 2) Что таблица Google Sheets (gid=993893041) опубликована в формате CSV (Файл -> Поделиться -> Опубликовать в интернете -> CSV), 3) Корректность URL.</p>
                                    </div>`;
        } finally {
          menuSpinner.style.display = 'none';
        }
      }

      // --- FETCH DATA FOR TRAINING (New) ---
      async function loadTrainingData() {
        trainingSpinner.classList.remove('hidden');
        trainingLinksContainer.innerHTML = '';
        try {
          // Используем fetchWithRetry
          const res = await fetchWithRetry(SHEET_URL_TRAINING);
          const text = await res.text();

          allTrainingMaterials = parseCSV(text, 'training');

          if (allTrainingMaterials.length === 0) {
            trainingLinksContainer.innerHTML = '<p class="col-span-full text-gray-800 text-center text-lg mt-8">Нет доступных обучающих материалов. Проверьте ссылку на Google Sheet и заголовки столбцов ("Название" и "ссылка").</p>';
          }

          renderTrainingButtons();

        } catch (e) {
          console.error('Training Data Load Error:', e);
          trainingLinksContainer.innerHTML = `<div class="col-span-full text-gray-800 text-center bg-red-100 p-6 rounded-xl shadow-lg border border-red-300 max-w-lg mx-auto mt-8">
                                      <p class="font-bold mb-2">Ошибка загрузки обучающих материалов!</p>
                                      <p class="text-sm">Пожалуйста, проверьте, что ссылка на Google Sheet (gid=1664366590) верна, таблица опубликована в формате CSV, и ваша сеть не блокирует запрос.</p>
                                    </div>`;
        } finally {
          trainingSpinner.classList.add('hidden');
        }
      }


      // --- LISTENERS ---

      searchInput.addEventListener('input', () => {
        // При изменении поиска, считываем активную категорию и перефильтровываем
        const activeCategory = document.querySelector('#filter-buttons button.active')?.textContent || 'Все';
        filterCards(activeCategory);
      });

      // Инициализация
      loadMenuData();
      // Убеждаемся, что при загрузке отображается страница "Меню"
      showPage('menu');
    });
  </script></body></html>
